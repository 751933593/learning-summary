### Shell编程

### 一、文本处理

#### 1. 文本处理工具

##### 1.1 grep

- 语法

  > grep	[选项]	'关键字'	文件名

- 常见命令

  | 选项  |              解释               |
  | :---: | :-----------------------------: |
  |  -i   |          不区分大小写           |
  |  -v   |            反向选择             |
  |  -w   |           按单词搜索            |
  |  -o   |         打印匹配关键字          |
  |  -c   |        统计匹配到的次数         |
  |  -n   |            显示行号             |
  |  -r   |        逐层遍历目录查找         |
  |  -l   |       只列出匹配的文件名        |
  |  -L   |      只列出不匹配的文件名       |
  | A/B/C | 查询前N行/查询后N行/查询先后N行 |
  |  -e   |          使用正则匹配           |
  |  ^$   |            匹配空行             |

- 示例

  ```shell
  # 向/etc/bashrs文件中添加配置
  vim /etc/bashrs
  alias grep='grep --color=auto'
  ```

##### 1.2 cut

- 语法

  > cut	[选项]	文件名

- 常见命令

  | 选项 |             解释              |
  | :--: | :---------------------------: |
  |  -c  |     以字符为单位进行分割      |
  |  -d  |     自定义分隔符，默认\t      |
  |  -f  | 与d一起使用，指定截取哪个区域 |

- 示例

  ```shell
  # 以：分割，取2、3行
  cut -d: -f2,3 hello.txt
  ```

##### 1.3 sort

- 语法

  > sort	[选项]	文件名

- 常见命令

  | 选项 |             解释             |
  | :--: | :--------------------------: |
  |  -u  |          去除重复行          |
  |  -r  |           降序排序           |
  |  -o  |    将排序结果输出到文件中    |
  |  -n  | 以数字排序，默认是按字符排序 |
  |  -t  |            分隔符            |
  |  -k  |            第N列             |
  |  -b  |         忽略前导空格         |
  |  -R  |           随机排序           |

- 示例

  ```shell
  # 以：分割，以数字进行排序
  sort -n -t: hello.txt
  ```

##### 1.4 uniq 去除连续重复的行

- 语法

  > uniq	[选项]	文件名

- 常见命令

  | 选项 |      解释      |
  | :--: | :------------: |
  |  -i  |   忽略大小写   |
  |  -c  | 统计重复行次数 |
  |  -d  |  只显示重复行  |

- 示例

  ```shell
  # 统计重复行的次数
  uniq -c hello.txt
  ```

##### 1.5 tee 将内容输入到文件

- 语法

  > tee	[选项]	文件名

- 常见命令

  | 选项 | 解释 |
  | :--: | :--: |
  |  -a  | 追加 |

- 示例

  ```shell
  # 将hello world追加到文件中
  echo hello world | tee hello.txt
  ```

##### 1.6 diff

- 语法

  > diff	[选项]	文件名1	文件名2

- 常见命令

  | 选项 |       解释       |
  | :--: | :--------------: |
  |  -b  |    不检查空格    |
  |  -B  |   不检查空白行   |
  |  -i  |   不检查大小写   |
  |  -w  |   忽略所有空格   |
  |  -c  | 以上下文格式显示 |
  |  -u  |  以合并格式显示  |

- 示例

  ```shell
  # 通过补丁的方式修改文件
  # 1.先找出两个文件的不同，将不同之处生成补丁文件
  # -N 将不存在的文件当作空文件处理
  diff -uN file1 file2 > file.patch
  # 2.将补丁文件放入到主文件中
  patch file1 file.patch
  # 3.验证
  diff file1 file2
  ```

##### 1.7 paste

- 语法

  > paste	[选项]	文件名1	文件名2

- 常见命令

  | 选项 |          解释          |
  | :--: | :--------------------: |
  |  -d  | 自定义间隔符，默认是/t |
  |  -s  |    串行处理，列转行    |

- 示例

  ```shell
  # 按行比较两个文件，中间以|分隔
  paste d| file1 file2
  ```

##### 1.8 tr 删除字符或字符转换

- 语法

  > tr	[选项]	字符集1	字符集2	<	文件名
  >
  > 选项为d且不写字符集2，即为删除

- 常见命令

  | 选项 |                解释                |
  | :--: | :--------------------------------: |
  |  -d  |                删除                |
  |  -s  | 删除所有重复出现字符，只保留第一个 |

- 示例

  ```shell
  # 将a字符转为1，b、c字符转为2
  tr 'abc' '12' hello.txt
  # 将小写字母转为大写字母
  tr 'a-z' 'A-Z' hello.txt
  ```

#### 2. bash的特性

##### 2.1 常用的快捷键

| 快捷键 |            解释            |
| :----: | :------------------------: |
|   ^c   |     终止前台运行的程序     |
|   ^z   | 将前台运行的程序挂起到后台 |
|   ^d   |      退出   等价exit       |
|   ^l   |            清屏            |
|   ^a   |   光标移动到命令的最前端   |
|   ^e   |   光标移动到命令的最后端   |
|   ^u   |     删除光标前所有字符     |
|   ^k   |     删除光标后所有字符     |
|   ^r   |        搜索历史命令        |

##### 2.2  常用通配符

|  符号  |                解释                |
| :----: | :--------------------------------: |
|   *    |        匹配0或多个任意字符         |
|   ？   |          匹配单个任意字符          |
| [a-z]  |  匹配[]中任意单个字符，或一组字符  |
| [!a-z] |                取反                |
| {1..3} | 匹配[]中任意单个字符，或一组字符串 |

##### 2.3 引号

|  符号  |           解释            |
| :----: | :-----------------------: |
| 双引号 |  允许里面有$引用其他变量  |
| 单引号 | 不允许里面有$引用其他变量 |

### 二、Shell基本语法

#### 1. 定义变量

##### 1.1 基本方式

```shell
a=123456
b="hello world $(date +%FT%T)"
```

##### 1.2 交互式定义变量

- 语法

  > read	[选项]	变量名

- 常见选项

  | 选项 |            解释            |
  | :--: | :------------------------: |
  |  -p  |     定义提示用户的信息     |
  |  -n  |     限制输入字符的长度     |
  |  -s  |      不显示输入的内容      |
  |  -t  | 限制用户输入时间，单位：秒 |

- 应用

  ```shell
  # 场景一：用户自定义变量值
  read -p '请输入用户名' username
  # 场景二：变量值来自文件
  read param1 param2 < hello.txt
  ```

##### 1.3 定义有类型的变量

- 语法

  > declare	[选项]	变量名=变量值

- 常见选项

  | 选项 |        解释        |
  | :--: | :----------------: |
  |  -i  |        整数        |
  |  -r  |        只读        |
  |  -a  |      普通数组      |
  |  -A  |      关联数组      |
  |  -x  | 将变量通过环境导出 |

- 应用

  ```shell
  declare -x JAVA_HOME=/usr/java/jdk1.8.0_231
  # 相当于
  JAVA_HOME=/usr/java/jdk1.8.0_231
  export JAVA_HOME
  ```

#### 2.用户变量和全局变量

|      位置       |             解释             |
| :-------------: | :--------------------------: |
|    ~/.bashrc    |     存放用户的别名和函数     |
| ~/.bash_profile |      存放用户的环境变量      |
| ~/.bash_logout  | 存放用户退出登录时执行的程序 |
|  /etc/profile   |       存放全局环境变量       |

#### 3.系统变量

|   变量名   |                  解释                  |
| :--------: | :------------------------------------: |
|     $?     | 上一条命令执行后返回的状态；0表示正常  |
|     $0     |         当前执行的程序或脚本名         |
|     $#     |         脚本后面接的参数的个数         |
|     $*     | 脚本后面所有的参数；参数之间用空格隔开 |
|     $@     |    脚本后面所有的参数；参数是独立的    |
|   $1-$9    |  脚本后面参数的位置；$1表示第一个参数  |
| ${10}-${n} |                                        |
|     $$     |          当前所在进程的进程号          |
|     $!     |  后台运行的最后一个进程号（当前终端）  |
|     !$     |      调用最后一条命令历史中的参数      |

#### 4.判断

```powershell
if [ condition ];then
		command
	elif [ condition ];then
		command
	else
		语句
fi
```

> 格式1：test 条件表达式
>
> 格式2：[ 条件表达式 ]
>
> 格式3：[[ 条件表达式 ]]	支持正则 =~

- 判断文件类型

  | 参数 |            解释            |
  | :--: | :------------------------: |
  |  -e  |      判断文件是否存在      |
  |  -f  |   判断文件是否是普通文件   |
  |  -d  |     判断文件是否是目录     |
  |  -L  |  判断文件是否是软连接文件  |
  |  -b  |  判断文件是否是块设备文件  |
  |  -S  |  判断文件是否是套接字文件  |
  |  -c  | 判断文件是否是字符设备文件 |
  |  -P  | 判断文件是否是命名管道文件 |
  |  -s  |   判断文件是否是非空文件   |

- 判断文件权限

  | 参数 |            解释            |
  | :--: | :------------------------: |
  |  -r  |      当前用户是否可读      |
  |  -w  |      当前用户是否可写      |
  |  -x  |     当前用户是否可执行     |
  |  -u  | 是否有suid，高级权限冒险位 |
  |  -g  | 是否有sgid，高级权限强制位 |
  |  -k  | 是否有t位，高级权限粘滞位  |

- 判断文件新旧

  |       参数        |                             解释                             |
  | :---------------: | :----------------------------------------------------------: |
  | file1  -nt  file2 |                    判断file1是否比file2新                    |
  | file1  -ot  file2 |                    判断file1是否比file2旧                    |
  | file1  -ef  file2 | 比较是否为同一个文件，或者用于判断硬链接，是否指向同一个inode |

- 判断整数

  | 参数 |   解释   |
  | :--: | :------: |
  | -eq  |   等于   |
  | -ne  |  不等于  |
  | -gt  |   大于   |
  | -lt  |   小于   |
  | -ge  | 大于等于 |
  | -le  | 小于等于 |

- 判断字符串

  |         参数         |          解释           |
  | :------------------: | :---------------------: |
  |          z           |  判断字符串长度是否为0  |
  |          n           | 判断字符串长度是否不为0 |
  | string1  =  string2  |   判断字符串是否相等    |
  | string1  !=  string2 |  判断字符串是否不相等   |

#### 5.循环

```powershell
for variable in {list}
	do 
		command
	done
	
for (( i=0;i<2;i++ ))
	do 
		echo $i
	done

while [ condition ]
	do
		command
	done
# until 条件为假进入循环	
until [ condition ]
	do
		command
	done
```

#### 6.expect远程登录

- 循环在指定服务器上创建用户和文件

  ```powershell
  #!/bin/env bash
  # 循环在指定服务器上创建用户和文件
  # 需要使用expect命令，需要下载：yum -y expect
  # 文件ip.txt 中存放有ip和密码，使用ssh远程登录，登录后添加用户
  while read ip password
  do
  # 启动expect，约定看见END时推出
  /usr/bin/ecpect <<-END &>/dev/null
  # 使用ssh远程登录
  spawn ssh root@$ip
  expect {
  "yes/no" { send "yes\r";exp_continue }
  "password" { send "$password\r" }
  }
  expect "#" { send "useradd yy1;rm -rf /tmp/*;exit\r" }
  expect eof
  END
  done < /home/ip.txt
  ```

- 将跳板机上yunwei用户的公钥推送到局域网内所有可以ping通的机器上

  ```powershell
  #!/bin/env bash
  # 1.判断跳板机上的yunwei账号是否存在
{
  	id yunwei
  	[ $? -ne 0 ] && useradd yunwei && echo 123456|passwd --stdin yunwei
  } &>/dev/null
  # 2.判断expect是否安装
  rpm -q expect
  [ $? -ne 0 ] && yum -y install expect
  ```
  
  然后登录yunwei账号：su - yunwei，在该用户下执行脚本
  
  ```powershell
  #!/bin/env bash
  home_dir=/home/yunwei
  # 1.判断yunwei用户的密钥对是否存在
  [ ! -f $home_dir/.ssh/id_rsa.pub ] && ssh-keygen -P '' -f $home_dir/.ssh/id_rsa &>/dev/null
  # 2.循环检查主机的网络并进行公钥的推送
  for i in `cat $home_dir/ip.txt`
  do
  	ip=`echo $i|cut -d: -f1`
  	password=`echo $i|cut -d: -f2`
  	ping -c1 $ip &>/dev/null
  	if [ $? -eq 0 ];then
  		/usr/bin/expect <<-END &>/dev/null
  		spawn ssh-copy-id root@$ip
  		expect "yes/no" { send "yes\r";exp_continue }
  		expect "password" { send "$password\r" }
  		expect eof
  		END
  	else
  		echo $ip >> $home_dir/ip_error.txt
  	fi
  done
  ```
#### 7.数组

- 普通数组

  ```powershell
  # 赋值
  array[0]=v0
  array=(v0 v1 v2 v3)
  array=(`cat /etc/passwd`)
  array=(`ls /root`)
  array=(sam jack july "xiao tian" [10]=linux)
  
  # 获取
  echo ${array[0]}
  echo ${array[*]}
  echo ${#array[*]}  # 获取数组里所有的元素个数
  echo ${!array[@]}  # 获取数组元素的索引下标
  echo ${array[@]:1:2}  # 访问指定的元素，从索引1开始，获取两个
  
  #查看普通数组信息
  declare -a
  ```

- 关联数组

  ```powershell
  # 声明 declare -A 数组名
  declare -A association_array
  
  # 赋值
  association_array[key]=value
  association_array=([k1]=v1 [k2]=v2 [k3]=v3)
  
  # 获取
  echo ${association_array[key]}
  
  #查看关联数组信息
  declare -A
  ```

#### 8.其他变量

- 获取文件的目录 或 获取文件名

  ```powershell
  aa=/home/liurunze/lrz_software/zookeeper.gz.tar
  # 获取文件的目录: /home/liurunze/lrz_software
  dirname $aa
  # 获取文件名: zookeeper.gz.tar
  basename $aa
  ```

- 变量值的删除和替换

  ```powershell
  # #是从左去除；%是从右去除；默认去掉/key/
  url=www.taobao.com
  echo ${#url} # 获取url的长度
  echo ${url#*.} # taobao.com
  echo ${url##*.} # com
  echo ${url%.*} # www.taobao
  echo ${url%%.*} # www
  ```

#### 9.case

- 语法结构

  ```powershell
  case var in
  pattern1)
  	command1
  	;;
  pattern2)
  	command2
  	;;
  		*)
  	command3
  	;;
  esac
  ```

#### 10.函数

- 定义函数

  ```powershell
  fun_name() # 函数名
  {
  	fun_body # 函数体
  }
  ```

- 调用函数

  ```powershell
  # 1.在控制台调用函数
  source XXX.sh  # source一下带有函数的shell脚本
  fun_name # 在控制台输入函数名，便可执行函数
  # 2.在脚本中调用函数
  ```
  

#### 11.正则表达式

支持正则的程序有：locate、find、vim、gerp、sed、awk

| 元字符 | 功能                                       | 备注 |
| ------ | ------------------------------------------ | ---- |
| .      | 匹配除了换行符以外的任意单个字符           |      |
| *      | 前导字符出现0次或连续多次                  |      |
| .*     | 任意长度字符                               |      |
| ^      | 以...开头                                  |      |
| $      | 以...结尾                                  |      |
| ^$     | 空行                                       |      |
| []     | 匹配括号里任意单个字符或一组单个字符       |      |
| [^]    | 匹配不包含括号里任意单个字符或一组单个字符 |      |
| ^[]    | 匹配以括号里任意单个字符或一组单个字符开头 |      |

| 元字符    | 功能                             | 备注         |
| --------- | -------------------------------- | ------------ |
| \\<       | 取单词的头                       |              |
| \\>       | 取单词的尾                       |              |
| \\<  \\>  | 精确匹配单词                     |              |
| \\{n\\}   | 匹配前导字符连续出现n次          |              |
| \\{n,\\}  | 配置前导字符至少连续出现n次      |              |
| \\{n,m\\} | 匹配前导字符连续出现n次和m次之间 |              |
| \\( \\)   | 保存被匹配的字符                 |              |
| \\d       | 匹配数字                         | [0-9]        |
| \\w       | 匹配数字、字母、下划线           | [a-zA-Z0-9_] |
| \\s       | 匹配空格、制表符、换页符等       | [\\t\\r\\n]  |

| 元字符 | 功能                   | 备注                               |
| ------ | ---------------------- | ---------------------------------- |
| +      | 匹配一个或多个前导字符 | ab+匹配abw、ab                     |
| ?      | 匹配另个或一个前导字符 | ab+匹配ab、a                       |
| \|     | 或                     |                                    |
| ()     | 组字符（看成整体）     | (my\|your)self匹配myself或yourself |
| {n}    | 前导字符重复n次        |                                    |
| {n,}   | 前导字符至少重复n次    |                                    |
| {n,m}  | 前导字符重复n到m次     |                                    |

| 扩展表达式 | 功能                       | 示例 |
| ---------- | -------------------------- | ---- |
| [:alnumm:] | 字母与数字字符             |      |
| [:alpha:]  | 字母字符（包括大小写）     |      |
| [:lower:]  | 小写字母                   |      |
| [:upper:]  | 大写字母                   |      |
| [:blank:]  | 空格与制表符               |      |
| [:digit:]  | 数字                       |      |
| [:punct:]  | 标点符号                   |      |
| [:space:]  | 包括换行符，回车等所有空白 |      |

#### 12.文本编辑工具sed

> stream editor
>
> sed把每一行都存在临时的缓冲区中，对副本进行编辑，所以sed不会修改原文件
>
> sed主要用来自动编辑一个或多个文件，简化对文件的反复操作，对文件进行过滤和转换操作

- 语法格式

  > sed	[options]	'处理动作'	文件名

- 常用选项

  | 选项 |          解释          |        备注        |
  | :--: | :--------------------: | :----------------: |
  |  -e  |  进行多项（多次）编辑  |                    |
  |  -n  |      取消默认输出      | 不自动打印模式空间 |
  |  -r  |   使用扩展正则表达式   |                    |
  |  -i  | 原地编辑（修改原文件） |                    |
  |  -f  |  指定sed脚本的文件名   |                    |

- 常用动作

  | 动作                       | 解释                                                   | 备注                              |
  | -------------------------- | ------------------------------------------------------ | --------------------------------- |
  | 'p'                        | 打印                                                   |                                   |
  | 'i'                        | 在指定行之前插入内容                                   |                                   |
  | 'a'                        | 在指定行之后插入内容                                   |                                   |
  | 'c'                        | 替换指定行所有内容                                     |                                   |
  | 'd'                        | 删除指定行                                             |                                   |
  | 's/搜索内容/替换内容/动作' | 对文件进行搜索替换动作，动作一般是p打印，或是g全局替换 |                                   |
  | 'r 文件名'                 | 从其他文件读取内容                                     |                                   |
  | 'w 文件名'                 | 内容另存为                                             |                                   |
  | '&'                        | 匹配到的字符串                                         | 和\\(\\)相同                      |
  | ‘=’                        | 打印行号                                               |                                   |
  | '!'                        | 取反，放到行数之后                                     |                                   |
  | 'q'                        | 退出                                                   |                                   |
  | '/key/'                    | 查询包含关键字的行                                     | sed -n '/root/p' 1.txt            |
  | '/key1/,/key2/'            | 匹配包含两个关键字之间的行                             | sed -n '/^admin/,/^mysql/p' 1.txt |
  | /key/,x                    | 匹配从关键字，到行号x之间的行                          | sed -n '/^ftp/,7p'                |
  | x,y!                       | 不包含x到y行                                           |                                   |
  | /key/!                     | 不包含关键字的行                                       | sed -n '/bash$/!p' 1.txt          |

- 实践

  ```powershell
   # 打印最后一行
   sed -n '$p' hello.txt
   # 打印1到3行
   sed -n '1-3p' hello.txt
   # 注释掉文件的1-5行内容
   sed -n '1,5s/^/#/p' hello.txt
   # 将不是aa开头的行注释掉
 sed -n '!s/^aa/#&/p' hello.txt
  ```
  
- 